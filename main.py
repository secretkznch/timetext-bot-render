"""
ü§ñ LSSD BOT - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è Render
–° –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º UTC –≤—Ä–µ–º–µ–Ω–µ–º –∏ keep-alive
"""

import requests
import json
import time
import os
from datetime import datetime
import schedule
import threading
import logging
from dotenv import load_dotenv
from flask import Flask, jsonify
from threading import Thread

# ===================== FLASK –î–õ–Ø RENDER =====================
app = Flask(__name__)

@app.route('/')
def home():
    return "ü§ñ LSSD Bot —Ä–∞–±–æ—Ç–∞–µ—Ç! –í—Ä–µ–º—è UTC, keep-alive –∫–∞–∂–¥—ã–µ 14 –º–∏–Ω"

@app.route('/health')
def health():
    return jsonify({
        "status": "ok",
        "time_utc": datetime.utcnow().strftime("%H:%M:%S"),
        "time_msk": (datetime.utcnow().hour + 3) % 24,
        "next_messages": get_next_messages()
    })

def get_next_messages():
    jobs = list(schedule.get_jobs())
    if not jobs:
        return "–ù–µ—Ç –∑–∞–¥–∞—á"
    next_job = min(jobs, key=lambda x: x.next_run)
    return f"–°–ª–µ–¥—É—é—â–µ–µ: {get_job_name(next_job)} –≤ {next_job.next_run.strftime('%H:%M UTC')}"

# ===================== –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–ê =====================
load_dotenv()

WEBHOOK_URL = os.getenv("WEBHOOK_URL", "https://discord.com/api/webhooks/1465437781269413939/KIgMfZGrjZD6u9CSi85-n0SuTr0aY0YRmGYQx3mn9qzgs3hCS12jJcpWTFXljD8872J0")

ROLES = {
    "LSSD": os.getenv("ROLE_LSSD", "714751439561293843"),
    "RD": os.getenv("ROLE_RD", "1095384636336644248"),
    "SEB": os.getenv("ROLE_SEB", "904140212211417090"),
    "PB": os.getenv("ROLE_PB", "904140453740412959"),
    "RDB": os.getenv("ROLE_RDB", "904140370605129769"),
}

CHANNELS = {
    "APPLICATIONS_RD": os.getenv("CHANNEL_APPLICATIONS_RD", "1275464311309078663"),
    "APPLICATIONS_SEB": os.getenv("CHANNEL_APPLICATIONS_SEB", "1275464288785661974"),
    "APPLICATIONS_PB": os.getenv("CHANNEL_APPLICATIONS_PB", "1275464251875790900"),
    "APPLICATIONS_RDB": os.getenv("CHANNEL_APPLICATIONS_RDB", "1275464215972548784"),
    "SERVER_ID": os.getenv("SERVER_ID", "714751439510962246")
}

# ===================== –í–ê–ñ–ù–û: –í–†–ï–ú–Ø –í UTC =====================
# –ú–æ—Å–∫–≤–∞ UTC+3: –≤—ã—á–∏—Ç–∞–µ–º 3 —á–∞—Å–∞
SCHEDULES = {
    "rd": ["07:00", "13:00", "18:00"],    # –ú–°–ö: 10:00, 16:00, 21:00
    "seb": ["08:30", "14:30", "19:00"],   # –ú–°–ö: 11:30, 17:30, 22:00
    "pb": ["06:00", "11:00", "16:30"],    # –ú–°–ö: 09:00, 14:00, 19:30
    "rdb": ["09:00", "15:00", "20:00"]    # –ú–°–ö: 12:00, 18:00, 23:00
}

# ===================== –¢–ï–ö–°–¢–´ –°–û–û–ë–©–ï–ù–ò–ô =====================
MESSAGES = {
    "rd": {
        "name": "Rangers Division",
        "content": """**–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, —É–≤–∞–∂–∞–µ–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ {LSSD}** 

üåü **–û—Ç–¥–µ–ª {RD} –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ–∏ –¥–≤–µ—Ä–∏ –¥–ª—è —Å–∞–º—ã—Ö –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã—Ö –∏ –ø—Ä–µ–¥–∞–Ω–Ω—ã—Ö –¥–µ–ª—É!** –ì–æ—Ç–æ–≤—ã –ª–∏ –≤—ã —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –∫–æ–º–∞–Ω–¥—ã –º–µ—á—Ç—ã?

**–ß—Ç–æ –≤–∞—Å –∂–¥–µ—Ç:**

üí∞ **–ë—ã—Å—Ç—Ä—ã–π –≤–∑–ª–µ—Ç –ø–æ –∫–∞—Ä—å–µ—Ä–Ω–æ–π –ª–µ—Å—Ç–Ω–∏—Ü–µ:** –í–∞—à–∏ —É—Å–∏–ª–∏—è –±—É–¥—É—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–º–µ—á–µ–Ω—ã –∏ —â–µ–¥—Ä–æ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω—ã!
ü§ù **–î—Ä—É–∂–Ω—ã–π –∫–æ–ª–ª–µ–∫—Ç–∏–≤:** –ó–∞–±—É–¥—å—Ç–µ –æ–± –∏–Ω—Ç—Ä–∏–≥–∞—Ö –∏ —Å–∫–ª–æ–∫–∞—Ö ‚Äî —É –Ω–∞—Å —Ü–∞—Ä–∏—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏!
üèûÔ∏è **–†–∞–±–æ—Ç–∞ –≤ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ:** –ó–∞–±—É–¥—å—Ç–µ –æ —Å–∫—É—á–Ω—ã—Ö –±—É–¥–Ω—è—Ö, –≤–∞—Å –∂–¥—É—Ç –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –±–ª–∞–≥–æ —à—Ç–∞—Ç–∞!
üåä **–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å–∞–º:** –í –≤–∞—à–µ–º —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏ –±—É–¥–µ—Ç –≤–æ–¥–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤—ã–∑–æ–≤—ã!

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç –≤–∞—Å:**

üß† **–ó–Ω–∞–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–≤ —à—Ç–∞—Ç–∞:** –ë—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ!
üöó **–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ:** –ë–µ–∑ –Ω–µ–≥–æ –Ω–∏–∫—É–¥–∞!
üé§ **–ß–µ—Ç–∫–∞—è —Ä–µ—á—å:** –í–∞–∂–Ω–æ —É–º–µ—Ç—å –¥–æ–Ω–æ—Å–∏—Ç—å —Å–≤–æ–∏ –º—ã—Å–ª–∏ –¥–æ –æ–∫—Ä—É–∂–∞—é—â–∏–º.
‚ôæÔ∏è **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –æ–±—É—á–µ–Ω–∏—é:** –ú–∏—Ä –Ω–µ —Å—Ç–æ–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ, –∏ –º—ã —Ç–æ–∂–µ! –†–∞–∑–≤–∏–≤–∞–π—Ç–µ—Å—å –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏!

**–í–∞—à–∞ –º–∏—Å—Å–∏—è:**

üé£ **–ü–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ö–æ—Ç–Ω–∏—á—å–∏—Ö –∏ —Ä—ã–±–æ–ª–æ–≤–Ω—ã—Ö —É–≥–æ–¥–∏–π:** –ù–∏ –æ–¥–∏–Ω –±—Ä–∞–∫–æ–Ω—å–µ—Ä –Ω–µ —É–π–¥–µ—Ç –æ—Ç –Ω–∞—Å –±–µ–∑–Ω–∞–∫–∞–∑–∞–Ω–Ω—ã–º!
üìú **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–π:** –ó–∞–∫–æ–Ω –µ—Å—Ç—å –∑–∞–∫–æ–Ω, –∏ –º—ã —Å–ª–µ–¥–∏–º –∑–∞ –µ–≥–æ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º!
üö® **–ó–∞–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π:** –ü—Ä–µ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–µ –ø—Ä–æ–π–¥–µ—Ç!

**–ù–µ —É–ø—É—Å—Ç–∏—Ç–µ —Å–≤–æ–π —à–∞–Ω—Å —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ {RD}!** 
üéØ **–ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤ –∫–∞–Ω–∞–ª–µ:** {APPLICATIONS_RD}

**–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É –æ—Ç–¥–µ–ª–∞ <@&1095388693512065095>**""",
        "roles": ["LSSD", "RD"],
        "channels": ["APPLICATIONS_RD"]
    },
    "seb": {
        "name": "Special Enforcement Bureau",
        "content": """**2. –£–≤–∞–∂–∞–µ–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ <@&{LSSD}>** 
üîπ **–ù–∞–±–æ—Ä –≤ –æ—Ç–¥–µ–ª <@&{SEB}> –æ—Ç–∫—Ä—ã—Ç!** üîπ **<@&{SEB}>**

–ï—Å–ª–∏ —Ç—ã –æ–±–ª–∞–¥–∞–µ—à—å 3 –ø–æ—Ä—è–¥–∫–æ–≤—ã–º —Ä–∞–Ω–≥–æ–º –∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≥–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—Ç—å, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∏—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ ‚Äî —É —Ç–µ–±—è –µ—Å—Ç—å —à–∞–Ω—Å —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é —ç–ª–∏—Ç—ã.

**<@&{SEB}>** ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ. –≠—Ç–æ –∫–æ–º–∞–Ω–¥–∞, –¥–µ–π—Å—Ç–≤—É—é—â–∞—è –≤ —Å–∞–º—ã—Ö —Å–ª–æ–∂–Ω—ã—Ö –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö. –ú—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫—Ç–æ –≥–æ—Ç–æ–≤ –±—Ä–∞—Ç—å –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –Ω–µ –±–æ–∏—Ç—Å—è —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π –∏ –≤—Å–µ–≥–¥–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö —Å–ª—É–∂–±—ã.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è:**

üîπ –ú–∏–Ω–∏–º—É–º 3 –ø–æ—Ä—è–¥–∫–æ–≤—ã–π —Ä–∞–Ω–≥
üîπ –û—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –∂–µ–ª–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –≤ —Å–æ—Å—Ç–∞–≤–µ SEB
üîπ –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, –ø—É–Ω–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å, —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—É–±–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
üîπ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ –∏ –ø–æ —É—Å—Ç–∞–≤—É

**–ß—Ç–æ –¥–∞—ë—Ç —Å–ª—É–∂–±–∞ –≤ SEB:**

üî∫ –†–∞–±–æ—Ç–∞ –Ω–∞ –ø–µ—Ä–µ–¥–æ–≤–æ–π
üî∫ –¢–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
üî∫ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —ç–ª–∏—Ç–Ω–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
üî∫ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ø–ª–æ—á—ë–Ω–Ω–æ–≥–æ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∞

**–ù–µ —É–ø—É—Å—Ç–∏—Ç–µ —Å–≤–æ–π —à–∞–Ω—Å —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ <@&{SEB}>!** 
üéØ **–ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤ –∫–∞–Ω–∞–ª–µ:** <#{APPLICATIONS_SEB}>

**–•–æ—á–µ—à—å —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –ª—É—á—à–∏—Ö? –ü–∏—à–∏!!!!**

**–ù–∞—á–∞–ª—å–Ω–∏–∫ –æ—Ç–¥–µ–ª–∞:** @Head SEB | Kagami Esser 
**–ó–∞–º –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞:** @D.Head SEB | Paradox Esser""",
        "roles": ["LSSD", "SEB"],
        "channels": ["APPLICATIONS_SEB"]
    },
    "pb": {
        "name": "Patrol Bureau",
        "content": """**3. –£–≤–∞–∂–∞–µ–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ <@&{LSSD}>
—Ö–æ—Ç–∏–º —Å–æ–æ–±—â–∏—Ç—å —á—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç **–ù–∞–±–æ—Ä –≤ –æ—Ç–¥–µ–ª: Patrol Bureau (<@&{PB}>)**,!

–ú—ã –∑–∞–Ω–∏–º–∞–µ–º—Å—è –ø–∞—Ç—Ä—É–ª—è–º–∏, –ø–æ–º–æ–≥–∞–µ–º –ª—é–¥—è–º –æ—Å–≤–æ–∏—Ç—å—Å—è
–∏ –≤–ª–∏—Ç—å—Å—è –≤ –∂–∏–∑–Ω—å –æ—Ç–¥–µ–ª–∞!

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã:**
- –ó–Ω–∞–Ω–∏–µ –æ—Å–Ω–æ–≤ –î–ö, –£–ê–ö, –ó–∞–∫–æ–Ω –æ "LSSD"
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö
- –ñ–µ–ª–∞–Ω–∏–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –æ—Ç–¥–µ–ª–æ–º

**–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç –Ω–∞—Å:**
- –ü—Ä–∏—è—Ç–Ω—ã–π –∫–æ–ª–ª–µ–∫—Ç–∏–≤, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ–≥–¥–∞ —Å–æ—Å—Ç–∞–≤–∏—Ç –∫–æ–º–ø–∞–Ω–∏—é
- –î–æ–±—Ä—ã–π —Å—Ç–∞—Ä—à–∏–π —Å–æ—Å—Ç–∞–≤, –ø—Ä–æ—Ç—è–≥–∏–≤–∞—é—â–∏–π —Ä—É–∫—É –ø–æ–º–æ—â–∏
- –ö—Ä–∞—Å–∏–≤–∞—è –∏ –ø—Ä–∏—è—Ç–Ω–∞—è –≥–ª–∞–∑—É —Ñ–æ—Ä–º–∞

**–° –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ–º –∂–¥—ë–º —Ç–≤–æ–µ–π –∑–∞—è–≤–∫–∏!**
üéØ **–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –º–æ–∂–Ω–æ –≤ –∫–∞–Ω–∞–ª–µ:** <#{APPLICATIONS_PB}>

**–û–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å—Ç–∞—Ä—à–µ–º—É —Å–æ—Å—Ç–∞–≤—É:**
–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –Ω–∞—á–∞–ª—å–Ω–∏–∫—É –æ—Ç–¥–µ–ª–∞ @[Head PB] Dmitry_Dronov""",
        "roles": ["LSSD", "PB"],
        "channels": ["APPLICATIONS_PB"]
    },
    "rdb": {
        "name": "Recruiting and Discipline Bureau",
        "content": """**4. –í–Ω–∏–º–∞–Ω–∏–µ <@&{LSSD}> !**

üìö **–û—Ç–¥–µ–ª <@&{RDB}> –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞–±–æ—Ä!** –í–æ–ø—Ä–æ—Å –≤ —Ç–æ–º, —Ö–≤–∞—Ç–∏—Ç –ª–∏ —É –≤–∞—Å –ñ–µ–ª–∞–Ω–∏—è, —Ç.–∫. —É –Ω–∞—Å –≤—ã –Ω–µ –±—É–¥–µ—Ç–µ –°–∏—Å–∏ –ú—è—Ç—å! 

–ù–∞—à –æ—Ç–¥–µ–ª –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏ —Ç–æ–ª—å–∫–æ –æ—Ç –≤–∞—Å –±—É–¥–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç LSSD –¥–ª—è –æ–±—â–µ—Å—Ç–≤–∞. –í–µ–¥—å –∏–º–µ–Ω–Ω–æ –≤—ã –±—É–¥–µ—Ç–µ –æ—Ç–≤–µ—á–∞—Ç—å –∑–∞ –æ–±—É—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –∏—Ö –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É. –ê –ø—Ä–∏ —Ö–æ—Ä–æ—à–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö –∫–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç –≤–∞–º –æ–±–µ—Å–ø–µ—á–µ–Ω –≤–ø–ª–æ—Ç—å –¥–æ –ó–∞–º. –ù–∞—á. –û—Ç–¥–µ–ª–∞ RDB!

**–ß—Ç–æ –º—ã –≤–∞–º –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º:**

‚Ä¢ ü™∂ **–õ—ë–≥–∫—É—é –°–∏—Å—Ç–µ–º—É –ø–æ–≤—ã—à–µ–Ω–∏—è**
‚Ä¢ üì£ **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–º–æ–≥–∞—Ç—å –Ω–∞ –Ω–∞–±–æ—Ä–∞—Ö**
‚Ä¢ üí∏ **–•–æ—Ä–æ—à–∏–µ –ø—Ä–µ–º–∏–∏ –∑–∞ —Ä–∞–±–æ—Ç—É**
‚Ä¢ üìà **–ë—ã—Å—Ç—Ä—ã–π –ö–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç**

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç –≤–∞—Å?**

‚Ä¢ –ñ–µ–ª–∞–Ω–∏–µ –†–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –±–ª–∞–≥–æ —Ñ—Ä–∞–∫—Ü–∏–∏
‚Ä¢ (–ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏) –∏–º–µ—Ç—å –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –≤ —Å—Ö–æ–∂–∏—Ö –æ—Ç–¥–µ–ª–∞—Ö
‚Ä¢ –£–¥–µ–ª—è—Ç—å —Ä–∞–±–æ—Ç–µ –≤—Ä–µ–º—è

–¢–∞–∫–∂–µ –Ω–∞–ø–æ–º–∏–Ω–∞—é —á—Ç–æ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ **–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—è –ù–∞—á–∞–ª—å–Ω–∏–∫–∞ –û—Ç–¥–µ–ª–∞** –∏ –º—ã –¥–∞–¥–∏–º —à–∞–Ω—Å –∫–∞–∂–¥–æ–º—É –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–µ–±—è –≤ —ç—Ç–æ–π —Ä–æ–ª–∏! 

üéØ **–ü–æ –ø–æ–≤–æ–¥—É –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π –ø–∏—à–∏—Ç–µ –≤ –∫–∞–Ω–∞–ª–µ:** <#{APPLICATIONS_RDB}>

**–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ù–∞—á–∞–ª—å–Ω–∏–∫ –û—Ç–¥–µ–ª–∞ RDB!**""",
        "roles": ["LSSD", "RDB"],
        "channels": ["APPLICATIONS_RDB"]
    }
}

# ===================== –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–ï =====================
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s UTC - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

# ===================== –§–£–ù–ö–¶–ò–ò =====================
def format_role_mention(role_key):
    return f"<@&{ROLES.get(role_key, role_key)}>" if role_key in ROLES else f"@{role_key}"

def format_channel_mention(channel_key):
    return f"<#{CHANNELS.get(channel_key, channel_key)}>" if channel_key in CHANNELS else f"#{channel_key}"

def prepare_message(message_key):
    msg_data = MESSAGES.get(message_key)
    if not msg_data:
        return ""
    
    content = msg_data["content"]
    for role in msg_data.get("roles", []):
        content = content.replace(f"{{{role}}}", format_role_mention(role))
    for channel in msg_data.get("channels", []):
        content = content.replace(f"{{{channel}}}", format_channel_mention(channel))
    
    return content

def send_webhook(content, username="LSSD Bot"):
    if not WEBHOOK_URL:
        logger.error("‚ùå –ù–µ—Ç WEBHOOK_URL")
        return False
    
    data = {
        "content": content,
        "username": username,
        "avatar_url": os.getenv("BOT_AVATAR", "https://i.postimg.cc/jSLXV2Rd/image.png")
    }
    
    try:
        response = requests.post(WEBHOOK_URL, json=data, timeout=10)
        if response.status_code in [200, 204]:
            logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {username}")
            return True
        else:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ {response.status_code}")
            return False
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}")
        return False

def send_rd():
    content = prepare_message("rd")
    return send_webhook(content, "Rangers Division")

def send_seb():
    content = prepare_message("seb")
    return send_webhook(content, "Special Enforcement Bureau")

def send_pb():
    content = prepare_message("pb")
    return send_webhook(content, "Patrol Bureau")

def send_rdb():
    content = prepare_message("rdb")
    return send_webhook(content, "Recruiting and Discipline Bureau")

# ===================== KEEP-ALIVE –î–õ–Ø RENDER =====================
def keep_alive_ping():
    """–í–ê–ñ–ù–û: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–æ–Ω Render"""
    logger.info("üîÑ Keep-alive: –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω")

# ===================== –ù–ê–°–¢–†–û–ô–ö–ê –†–ê–°–ü–ò–°–ê–ù–ò–Ø =====================
def setup_schedule():
    schedule.clear()
    
    # –í–ê–ñ–ù–û: Keep-alive –∫–∞–∂–¥—ã–µ 14 –º–∏–Ω—É—Ç (–º–µ–Ω—å—à–µ 15!)
    schedule.every(14).minutes.do(keep_alive_ping)
    
    # –†–ê–°–ü–ò–°–ê–ù–ò–ï –í UTC!
    # RD
    for t in SCHEDULES["rd"]:
        schedule.every().day.at(t).do(send_rd)
        logger.info(f"üìÖ RD –≤ {t} UTC ({int(t[:2])+3}:{t[3:]} –ú–°–ö)")
    
    # SEB
    for t in SCHEDULES["seb"]:
        schedule.every().day.at(t).do(send_seb)
        logger.info(f"üìÖ SEB –≤ {t} UTC ({int(t[:2])+3}:{t[3:]} –ú–°–ö)")
    
    # PB
    for t in SCHEDULES["pb"]:
        schedule.every().day.at(t).do(send_pb)
        logger.info(f"üìÖ PB –≤ {t} UTC ({int(t[:2])+3}:{t[3:]} –ú–°–ö)")
    
    # RDB
    for t in SCHEDULES["rdb"]:
        schedule.every().day.at(t).do(send_rdb)
        logger.info(f"üìÖ RDB –≤ {t} UTC ({int(t[:2])+3}:{t[3:]} –ú–°–ö)")
    
    logger.info(f"‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ. –ó–∞–¥–∞—á: {len(schedule.get_jobs())}")

def get_job_name(job):
    func_name = job.job_func.__name__
    if "rd" in func_name: return "RD"
    if "seb" in func_name: return "SEB"
    if "pb" in func_name: return "PB"
    if "rdb" in func_name: return "RDB"
    if "keep" in func_name: return "Keep-alive"
    return "Unknown"

# ===================== –û–°–ù–û–í–ù–û–ô –ü–õ–ê–ù–ò–†–û–í–©–ò–ö =====================
def run_scheduler():
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞"""
    logger.info("üöÄ LSSD Bot –∑–∞–ø—É—â–µ–Ω (UTC –≤—Ä–µ–º—è)")
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    setup_schedule()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    send_webhook("ü§ñ LSSD Bot –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º UTC –≤—Ä–µ–º–µ–Ω–µ–º", "–°–∏—Å—Ç–µ–º–∞")
    
    # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
    while True:
        try:
            schedule.run_pending()
            time.sleep(58)  # 58 —Å–µ–∫—É–Ω–¥
            
            # –õ–æ–≥ –∫–∞–∂–¥—ã–π —á–∞—Å
            if datetime.now().minute == 0:
                logger.info(f"‚è∞ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è UTC: {datetime.utcnow().strftime('%H:%M')}")
                
        except KeyboardInterrupt:
            break
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            time.sleep(60)

# ===================== –ó–ê–ü–£–°–ö FLASK =====================
def run_flask_server():
    """–ó–∞–ø—É—Å–∫–∞–µ–º Flask —Å–µ—Ä–≤–µ—Ä –¥–ª—è Render"""
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port, debug=False, use_reloader=False)

# ===================== –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö =====================
if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = Thread(target=run_flask_server, daemon=True)
    flask_thread.start()
    
    # –î–∞–µ–º Flask –≤—Ä–µ–º—è –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
    time.sleep(3)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    try:
        run_scheduler()
    except Exception as e:
        logger.error(f"üíÄ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")

